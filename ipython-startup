#!/usr/bin/env python
# coding: utf-8

import os
import logging
import concurrent.futures

from glob import glob
from sudoku import solve, Puzzle, Box, Row, Col
from sudoku.const import ELEMENT_VALUES as EV
from sudoku import get_puzzles

log = logging.getLogger('ipy')

def sorta_true(X):
    if isinstance(X, str):
        if X.lower() in ('t', 'true', 'y', 'yes'):
            return True
        if X.lower() in ('f', 'false', 'n', 'no'):
            return False
        try:
            x = int(X)
            if x == 0:
                return False
            return True
        except ValueError:
            pass
    return bool(X)

def maybe_solve(p):
    if sorta_true(os.environ.get("NO_SOLVE")):
        return None
    if so := os.environ.get("SOLVE_ONLY"):
        for item in so.split():
            try:
                item = int(item)
                if P[item] is p:
                    return solve(p)
            except ValueError:
                pass
        return None
    return solve(p)

def reload_puzzles():
    global P, Q
    P = list(get_puzzles())

    for file in glob('t/asset/p*.txt'):
        bname = os.path.basename(file)[:-4]
        P.extend(get_puzzles(file))

    for i,p in enumerate(P):
        globals()[f'p{i}'] = p

    L = len(P)
    # ThreadPoolExecutor(max_workers=) defaults to min(32, os.cpu_count() + 4)
    with concurrent.futures.ThreadPoolExecutor() as executor:
        Q = list(executor.map(maybe_solve, P))

    for i,q in enumerate(Q):
        if q is not None:
            globals()[f'q{i}'] = q

    log.debug("loaded %d puzzles in 'P' and 'p0' … 'pN'", len(P))
    log.debug("loaded %d corresponding solution(s) in 'Q' and 'q0' … 'qN'", len(list(x for x in Q if x is not None)))

    for i in range(1,4,1):
        j = len(P) - i
        if Q[-i] is not None:
            log.debug("pm%d/qm%d => p%d/q%d", i, i, j, j)
            globals()[f'pm{i}'] = P[-i]
            globals()[f'qm{i}'] = Q[-i]
        else:
            log.debug("pm%d => p%d", i, j)
            globals()[f'pm{i}'] = P[-i]

reload_puzzles()
